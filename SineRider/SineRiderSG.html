<!-------	[  This is free and unencumbered software released into the public domain  ]	------->
<!DOCTYPE html>
<canvas id="gc" width="1600" height="800" style="z-index: -2;"></canvas>
<canvas id="XYZ" width="500" height="400" style="display: none; z-index: 0; /*border: 1px solid #AAAAAA;*/ position:absolute;left:1100px;top:0px;"></canvas>
<canvas id="XYZ2" width="500" height="400" style="display: none; z-index: 0; /*border: 1px solid #AAAAAA;*/ position:absolute;left:1100px;top:1px;" ></canvas>

<head>
	<link rel="icon" href="SineRiderSGLogo.png">
	<link rel="shortcut icon" href="SineRiderSGLogo.png">
	<title>Sine Rider SG</title>
	<!--		Prevent accidental scaling when holding Ctrl and zooming in		-->
	<!--	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">	-->
</head>

<!--		Dissable right click menu		-->
<body oncontextmenu="return false;"></body>

<!--	Load External Libraries	-->
<!--From   https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.14.2/math.min.js-->
<script src="js/Math.js"></script>

<!--	Load Internal Scripts	-->
<script type="text/javascript" src="js/Collisions.js"></script>
<script type="text/javascript" src="js/Sledder.js"></script>
<script type="text/javascript" src="js/EquationLine.js"></script>
<script type="text/javascript" src="js/LevelSaver.js"></script>
<script type="text/javascript" src="js/LevelLoader.js"></script>
<script type="text/javascript" src="js/XYZView.js"></script>
<script type="text/javascript" src="js/3B1BAnimations.js"></script>
<script type="text/javascript" src="js/SvgEditor.js"></script>
<script type="text/javascript" src="js/AudioControl.js"></script>
<script type="text/javascript" src="js/Pause.js"></script>
<script type="text/javascript" src="js/InputManager.js"></script>
<script type="text/javascript" src="js/Menu.js"></script>

<!--		Remove white space around canvas (also makes cursor more accurate)		-->
<body style="margin: 0;"></body>

<!--		File Loader		-->
<input type="file" id="files" hidden="hidden" name="files[]" multiple />
<output id="list"></output>
<script>
	function handleFileSelect(evt) {
		var files = evt.target.files; // FileList object

		// files is a FileList of File objects. List some properties.
		var output = [];
		for (var i = 0, f; f = files[i]; i++) {
			output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
				f.size, ' bytes, last modified: ',
				f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
				'</li>');
		}
		document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
	}

	document.getElementById('files').addEventListener('change', handleFileSelect, false);
</script>
<!--		File Loader		-->



<script>
	//		Ctrl+Shift+J	shows error log in Chrome
	
	//		time
	var frameTime = 0;//		time since level started (used as t in equations)
	var lastTime = 0;
	var dt = 0.01;//		change in time since last frame
	//var lastTimeRaw = 0;

	//		temporary variables (all of these are used in multiple places. This is to avoid the inefficiency of redeclaring i 10 times a frame)
	//		all these variables should be assumed to be reset outside the context of a single function
	var dx = 0;//	float
	var dy = 0;//	float
	var lyy = 0;//	float
	var ryy = 0;//	float
	var dydt = 0;//	float
	var dxdt = 0;//	float
	var i = 0;//	int
	var k = 0;//	int
	var ftmp = 0;//	float
	var dtmp = 0;//	float
	var ltmp = 0;//	float
	var rtmp = 0;//	float
	var stmp = "";//	string
	var tmspx;
	var tmspy;
	var tmspz;
	var onOff = false;

	//		should be deleted before launch
	var debugSkipFrame = false;
	var debugSingleFrame = false;
	var debugFramerateCount = 0;
	var debugFramerateLast = 0;
	var debugFramerateTime = 0;
	var debugFastForward = false;

	//		camera position and scale. These coordinates are the position of the upper left corner of the screen.
	var screenWidth = 1600;
	var screenHeight = 800;
	var screenx = 0;
	var screeny = 0;
	var screenScale = 20;
	var trackPointx = 0;//		point the camera will try to keep on screen
	var trackPointy = 0;

	//		gameplay state
	var simulating = false;//		game is running. Sled is moving.
	var paused = false;//		player has not paused and window is in focus
	var menuOpen = false;//		game is paused because the menu is open
	var writeCursor = false;

	//		canvas
	var canvas;//		main canvas for 2D elements
	var ctx;
	var xyz;//		canvas for 3D elements
	var xyzc;
	var xyzWidth = 500;
	var xyzHeight = 500;
	var xyz2;//		duplicate of xyz offset down 1 pixel on the Y to fill in 1 pixel gaps caused by a low sample rate.
	var xyz2c;

	var mainInput;
	var piecInput = new Array();

	var parenOpen = 0;

	var timestamp;//		used only for running update()

	window.onload = function(){
		canvas = document.getElementById('gc');
		ctx = canvas.getContext('2d');
		xyzc = document.getElementById('XYZ');
		xyz  = xyzc.getContext('2d');
		xyz2c = document.getElementById('XYZ2');
		xyz2  = xyz2c.getContext('2d');
		document.body.style.overflow = 'hidden';//		turn off page scrolling
		lastTime = performance.now()*0.001;

		mainInput = document.createElement("p");
		mainInput.setAttribute("id" , "input0");
		mainInput.setAttribute("contentEditable" , "true");
		mainInput.style = "position:absolute;left:80px;top:680px;width:1440px;font-size:50px; font-family:'Arial'; background-color: #FFFFFF; border:1px solid #AAAAAA;";
		mainInput.innerHTML = "-x"
		document.body.appendChild(mainInput);
		piecInput.push(mainInput);

		saveLevel();//		for testing
		buildLevelMap();//		for testing
		loadLevelMap();//		for testing
		//ctx.save();
		/*c.addEventListener('mousemove' , function(e){
			mx = e.clientX-6;
			my = e.clientY-6;
		})*/
		setUpSledder();
		window.requestAnimationFrame(update);
		setUpXYZ();

		//		-----------------------------------------------------------------------		[   Page Icon   ]		-----------------------------------------------------------------------
		var link = document.querySelector("link[rel*='icon']") || document.createElement('link');
		link.type = 'image/x-icon';
		link.rel = 'shortcut icon';
		link.href = 'SineRiderSGLogo.png';
		document.getElementsByTagName('head')[0].appendChild(link);
	}
	
//		-----------------------------------------------------------------------		[   Toggle FullScreen   ]		-----------------------------------------------------------------------
	document.addEventListener("keydown", function(e){
	//	stmp = "cow";
	//	mainInput.setAttribute("value", "<span style='color:red;'>cat</span>");
	//	mainInput.html("<span style='color:red;'>cow</span>");
	//	console.log(mainInput.contentEditable);
		if (e.keyCode == 32){//		shift = 16		//		escape = 27
			//		folowing code from		https://xparkmedia.com/blog/enter-fullscreen-mode-javascript/
			if((document.fullScreenElement && document.fullScreenElement !== null) || (!document.mozFullScreen && !document.webkitIsFullScreen)) {
				//		switch to fullscreen
				screenWidth = window.screen.width * window.devicePixelRatio;
				screenHeight = window.screen.height * window.devicePixelRatio;
				if(document.documentElement.requestFullScreen) {
					document.documentElement.requestFullScreen();
				}else if (document.documentElement.mozRequestFullScreen) {
					document.documentElement.mozRequestFullScreen();
				}else if (document.documentElement.webkitRequestFullScreen) {
					document.documentElement.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
				}
				//		make sure the screen is always landscape
				if(screenHeight > screenWidth){
					k = screenHeight;
					screenHeight = screenWidth;
					screenWidth = k;
				}
			}else{//		exit fullscreen
				screenWidth = 1600;
				screenHeight = 800;
				if (document.cancelFullScreen) {
					document.cancelFullScreen();
				}else if (document.mozCancelFullScreen) {
					document.mozCancelFullScreen();
				}else if (document.webkitCancelFullScreen) {
					document.webkitCancelFullScreen();
				}
			}
			//		keep 3D view in right corner of view
			console.log("fullscreen");
			xyzc.style.left = screenWidth-600 + "px";
			xyz2c.style.left = screenWidth-600 + "px";
			canvas.width = screenWidth;
			canvas.height = screenHeight;
			equInputField = piecInput[0].style;
			equInputField.left = Math.round(screenWidth * 0.05) + "px";
			equInputField.top = Math.round(screenHeight * 0.85) + "px";
			equInputField.width = Math.round(screenWidth * 0.9) + "px";
		}
		//		-----------------------------------------------------------------------		[   MAIN MENU   ]		-----------------------------------------------------------------------
		if(e.keyCode == 192){
			if(menuOpen){//		hide main menu
				showHideInputs(true);
				menuOpen = false;
				paused = false;
			}else{//		show main menu
				drawMainMenu();//		see Menu.js
				showHideInputs(false);//		see InputManager.js
				menuOpen = true;
				paused = true;
			}
		}
	}, false);

		//		-----------------------------------------------------------------------		[   UPDATE   ]		-----------------------------------------------------------------------
	function update(timestamp){
		window.requestAnimationFrame(update);
		if(paused){
			if(menuOpen){
				MMDrawLine();
			}
			return;
		}
		dt = Math.min(performance.now()*0.001 - lastTime , 0.25);//		no frame can skip more than 1/4 seconds
		lastTime = performance.now()*0.001;
		if(useZ)
			drawXYZ();//		update the 3D view

		//		-----------------------------------------------------------------------		[   Debugging   ]		-----------------------------------------------------------------------
		//		incrament every frame. Reset at every second.
		if(lastTime - debugFramerateTime > 1){
			debugFramerateTime = lastTime;
			debugFramerateLast = debugFramerateCount;
			debugFramerateCount = 0;
			if(useZ){//		change the 3D view update frequency based on framerate
				if(debugFramerateLast < 30){
					if(debugFramerateLast < 20)
						scanStep = 2;
					else
						scanStep = 6;
				}else{
					if(debugFramerateLast > 57)
						scanStep = 12;
					else
						scanStep = 8;
				}
			}
		}else{
			debugFramerateCount++;
		}
		
		//				Debug pause and frame advance//		Hold Ctrl to pause. Press Z to advance single frames
		document.body.onkeydown = function(e){
		//	console.log("Pressed Key " + e.keyCode);
			if(e.keyCode == 17){//		Ctrl
				debugFastForward = true;
			}
			if(e.keyCode == 20){//		CapsLock
				debugSkipFrame = true;
			}else if(e.keyCode == 16){//		Shift
				writeCursor = true;
			}
			if(e.keyCode == 90){//		Z
				debugSingleFrame = true;
			}
		}

		document.onkeyup = function(e){
		//	console.log("Released Key " + e.keyCode);
			//		update the active input 
			if(usePiecewise){//		if multiple inputs and current input is not mainInput
				for(i = 0 ; i < piecSecCount ; i++){//		check all input fields and set whichever is avtive as mainInput
					if(piecInput[i] == document.activeElement){
						checkInputFields(i);
						break;
					}
				}
			}else{//		not piecewise. Use normal input (0)
				checkInputFields(0);//		see EquationLine.js
			}
			if(e.keyCode == 17){//		Ctrl
				debugFastForward = false;
			}
			if(e.keyCode == 16){//		Shift
				writeCursor = false;
			}
			if(e.keyCode == 20){//		CapsLock
				debugSkipFrame = false;
			}
		}
		
		if(debugFastForward){
			dt *= 4;
			//console.log("a " + dt);
		}

		if(debugSkipFrame && !debugSingleFrame){
			//drawNumberLines();//		see 3B1BAnimations
			return;
		}
		debugSingleFrame = false;
		//				Debug pause and frame advance
		//		-----------------------------------------------------------------------		[   /Debugging   ]		-----------------------------------------------------------------------
		
		//		canvas
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		drawGrid();
		//		on enter down toggle equation editable and simulation running
		//		get keycodes from here: https://css-tricks.com/snippets/javascript/javascript-keycodes/
		document.body.onkeyup = function(e){
			if(e.keyCode == 13){//		enter
				resetSledder();
				checkInputFields();//		update line. (useful if the player types something while the simulation is running)
			}
		}


		
		//		console.log("c " + dt);
		if(simulating){
			frameTime += dt;
		}else{//		-----------------------------------------------------------------------		[   Editing Equation   ]		-----------------------------------------------------------------------
			frameTime = 0;
		}

		drawLine();
		moveSledder();//		see sledder.js
		
		
		if(writeCursor){
			cursorPosition();//		see EquationLine.js
		}

		ctx.fillText( Math.round(debugFramerateLast).toString() + "fps" , Math.round(screenWidth * 0.8) , Math.round(screenHeight*0.85));
		//ctx.fillText("Scale = " + String(Math.round(screenScale)) , Math.round(screenWidth * 0.7) , Math.round(screenHeight*0.92));

		//ctx.fillText( "Scale = " + Math.round(screenScale).toString() , Math.round(screenWidth * 0.8) , Math.round(screenHeight*0.9));
		drawColliders();//		see collisions.js
		drawNumberLines();//		see 3B1BAnimations

		//		display X and Y of graph closest to cursor when I hold Ctrl
	}
	//		-----------------------------------------------------------------------		[   /UPDATE/   ]		-----------------------------------------------------------------------

</script>


<div id="slidecontainer">
	<!--
	<input type="range" min="-3000" max="3000" value="400" class="slider" id="rangeX" width="400">
	-->

	<!--
	<input type="range" min="0" max="100" value="100" class="slider" id="rangeY" width="400">
	<input type="range" min="0" max="100" value="0" class="slider" id="rangeZ" width="400">
	
	<input type="range" min="-200" max="200" value="0" class="slider" id="viewY" width="400">
	<input type="range" min="-314" max="314" value="-100" class="slider" id="viewRotate" width="400">-->
</div>

<script>
	/*document.getElementById("rangeX").oninput = function () {
		camx = Math.round(this.value);
	}
	document.getElementById("rangeY").oninput = function () {
		animX = this.value/100;
	}
	document.getElementById("rangeZ").oninput = function () {
		animY = this.value/100;
	}

	
	document.getElementById("viewY").oninput = function () {
		apz = this.value/10;
	}
	document.getElementById("viewRotate").oninput = function () {
		viewAngle = -this.value/100;
	}*/
</script>
